#include "idt.h"


idt_entry idt[256];
idt_reg idtr;

void set_idt_entry(int index, unsigned int base){
    	idt[index].base_low  = base & 0xFFFF;
	idt[index].base_high = (base >> 16) & 0xFFFF;
    	idt[index].selector  = KERNEL_CS;
	idt[index].reserved  = 0;
	idt[index].flags     = IDT_FLAGS;
}

void watch(){
	static unsigned int time=0;
	char s[2];
	s[1] = '\0';

	if(time%1000==0){
		s[0] = ((time/1000) % 10) + 0x30;
		kprint("Tick:");
		kprint(s);
		kprint("\n");
	}
	time+=55;
}

void init_irq(){
	byte_out(0x20, 0x11);
	byte_out(0xA0, 0x11);
	byte_out(0x21, 0x20);
	byte_out(0xA1, 0x28);
	byte_out(0x21, 0x04);
	byte_out(0xA1, 0x02);
	byte_out(0x21, 0x01);
	byte_out(0xA1, 0x01);
	byte_out(0x21, 0x0);
	byte_out(0xA1, 0x0);
	
	register_isr_callback(IRQ0,&watch);
}

void init_idt(){
	idtr.limit = sizeof(idt_entry) * 256 - 1;
	idtr.base = (unsigned int) &idt;

	set_idt_entry(0,(unsigned int)isr0);
	set_idt_entry(1,(unsigned int)isr1);
	set_idt_entry(2,(unsigned int)isr2);
	set_idt_entry(3,(unsigned int)isr3);
	set_idt_entry(4,(unsigned int)isr4);
	set_idt_entry(5,(unsigned int)isr5);
	set_idt_entry(6,(unsigned int)isr6);
	set_idt_entry(7,(unsigned int)isr7);
	set_idt_entry(8,(unsigned int)isr8);
	set_idt_entry(9,(unsigned int)isr9);
	set_idt_entry(10,(unsigned int)isr10);
	set_idt_entry(11,(unsigned int)isr11);
	set_idt_entry(12,(unsigned int)isr12);
	set_idt_entry(13,(unsigned int)isr13);
	set_idt_entry(14,(unsigned int)isr14);
	set_idt_entry(15,(unsigned int)isr15);
	set_idt_entry(16,(unsigned int)isr16);
	set_idt_entry(17,(unsigned int)isr17);
	set_idt_entry(18,(unsigned int)isr18);
	set_idt_entry(19,(unsigned int)isr19);
	set_idt_entry(20,(unsigned int)isr20);
	set_idt_entry(21,(unsigned int)isr21);
	set_idt_entry(22,(unsigned int)isr22);
	set_idt_entry(23,(unsigned int)isr23);
	set_idt_entry(24,(unsigned int)isr24);
	set_idt_entry(25,(unsigned int)isr25);
	set_idt_entry(26,(unsigned int)isr26);
	set_idt_entry(27,(unsigned int)isr27);
	set_idt_entry(28,(unsigned int)isr28);
	set_idt_entry(29,(unsigned int)isr29);
	set_idt_entry(30,(unsigned int)isr30);
	set_idt_entry(31,(unsigned int)isr31);
	set_idt_entry(32,(unsigned int)irq0);
	set_idt_entry(33,(unsigned int)irq1);
	set_idt_entry(34,(unsigned int)irq2);
	set_idt_entry(35,(unsigned int)irq3);
	set_idt_entry(36,(unsigned int)irq4);
	set_idt_entry(37,(unsigned int)irq5);
	set_idt_entry(38,(unsigned int)irq6);
	set_idt_entry(39,(unsigned int)irq7);
	set_idt_entry(40,(unsigned int)irq8);
	set_idt_entry(41,(unsigned int)irq9);
	set_idt_entry(42,(unsigned int)irq10);
	set_idt_entry(43,(unsigned int)irq11);
	set_idt_entry(44,(unsigned int)irq12);
	set_idt_entry(45,(unsigned int)irq13);
	set_idt_entry(46,(unsigned int)irq14);
	set_idt_entry(47,(unsigned int)irq15);
	set_idt_entry(48,(unsigned int)isr48);
	set_idt_entry(49,(unsigned int)isr49);
	set_idt_entry(50,(unsigned int)isr50);
	set_idt_entry(51,(unsigned int)isr51);
	set_idt_entry(52,(unsigned int)isr52);
	set_idt_entry(53,(unsigned int)isr53);
	set_idt_entry(54,(unsigned int)isr54);
	set_idt_entry(55,(unsigned int)isr55);
	set_idt_entry(56,(unsigned int)isr56);
	set_idt_entry(57,(unsigned int)isr57);
	set_idt_entry(58,(unsigned int)isr58);
	set_idt_entry(59,(unsigned int)isr59);
	set_idt_entry(60,(unsigned int)isr60);
	set_idt_entry(61,(unsigned int)isr61);
	set_idt_entry(62,(unsigned int)isr62);
	set_idt_entry(63,(unsigned int)isr63);
	set_idt_entry(64,(unsigned int)isr64);
	set_idt_entry(65,(unsigned int)isr65);
	set_idt_entry(66,(unsigned int)isr66);
	set_idt_entry(67,(unsigned int)isr67);
	set_idt_entry(68,(unsigned int)isr68);
	set_idt_entry(69,(unsigned int)isr69);
	set_idt_entry(70,(unsigned int)isr70);
	set_idt_entry(71,(unsigned int)isr71);
	set_idt_entry(72,(unsigned int)isr72);
	set_idt_entry(73,(unsigned int)isr73);
	set_idt_entry(74,(unsigned int)isr74);
	set_idt_entry(75,(unsigned int)isr75);
	set_idt_entry(76,(unsigned int)isr76);
	set_idt_entry(77,(unsigned int)isr77);
	set_idt_entry(78,(unsigned int)isr78);
	set_idt_entry(79,(unsigned int)isr79);
	set_idt_entry(80,(unsigned int)isr80);
	set_idt_entry(81,(unsigned int)isr81);
	set_idt_entry(82,(unsigned int)isr82);
	set_idt_entry(83,(unsigned int)isr83);
	set_idt_entry(84,(unsigned int)isr84);
	set_idt_entry(85,(unsigned int)isr85);
	set_idt_entry(86,(unsigned int)isr86);
	set_idt_entry(87,(unsigned int)isr87);
	set_idt_entry(88,(unsigned int)isr88);
	set_idt_entry(89,(unsigned int)isr89);
	set_idt_entry(90,(unsigned int)isr90);
	set_idt_entry(91,(unsigned int)isr91);
	set_idt_entry(92,(unsigned int)isr92);
	set_idt_entry(93,(unsigned int)isr93);
	set_idt_entry(94,(unsigned int)isr94);
	set_idt_entry(95,(unsigned int)isr95);
	set_idt_entry(96,(unsigned int)isr96);
	set_idt_entry(97,(unsigned int)isr97);
	set_idt_entry(98,(unsigned int)isr98);
	set_idt_entry(99,(unsigned int)isr99);
	set_idt_entry(100,(unsigned int)isr100);
	set_idt_entry(101,(unsigned int)isr101);
	set_idt_entry(102,(unsigned int)isr102);
	set_idt_entry(103,(unsigned int)isr103);
	set_idt_entry(104,(unsigned int)isr104);
	set_idt_entry(105,(unsigned int)isr105);
	set_idt_entry(106,(unsigned int)isr106);
	set_idt_entry(107,(unsigned int)isr107);
	set_idt_entry(108,(unsigned int)isr108);
	set_idt_entry(109,(unsigned int)isr109);
	set_idt_entry(110,(unsigned int)isr110);
	set_idt_entry(111,(unsigned int)isr111);
	set_idt_entry(112,(unsigned int)isr112);
	set_idt_entry(113,(unsigned int)isr113);
	set_idt_entry(114,(unsigned int)isr114);
	set_idt_entry(115,(unsigned int)isr115);
	set_idt_entry(116,(unsigned int)isr116);
	set_idt_entry(117,(unsigned int)isr117);
	set_idt_entry(118,(unsigned int)isr118);
	set_idt_entry(119,(unsigned int)isr119);
	set_idt_entry(120,(unsigned int)isr120);
	set_idt_entry(121,(unsigned int)isr121);
	set_idt_entry(122,(unsigned int)isr122);
	set_idt_entry(123,(unsigned int)isr123);
	set_idt_entry(124,(unsigned int)isr124);
	set_idt_entry(125,(unsigned int)isr125);
	set_idt_entry(126,(unsigned int)isr126);
	set_idt_entry(127,(unsigned int)isr127);
	set_idt_entry(128,(unsigned int)isr128);
	set_idt_entry(129,(unsigned int)isr129);
	set_idt_entry(130,(unsigned int)isr130);
	set_idt_entry(131,(unsigned int)isr131);
	set_idt_entry(132,(unsigned int)isr132);
	set_idt_entry(133,(unsigned int)isr133);
	set_idt_entry(134,(unsigned int)isr134);
	set_idt_entry(135,(unsigned int)isr135);
	set_idt_entry(136,(unsigned int)isr136);
	set_idt_entry(137,(unsigned int)isr137);
	set_idt_entry(138,(unsigned int)isr138);
	set_idt_entry(139,(unsigned int)isr139);
	set_idt_entry(140,(unsigned int)isr140);
	set_idt_entry(141,(unsigned int)isr141);
	set_idt_entry(142,(unsigned int)isr142);
	set_idt_entry(143,(unsigned int)isr143);
	set_idt_entry(144,(unsigned int)isr144);
	set_idt_entry(145,(unsigned int)isr145);
	set_idt_entry(146,(unsigned int)isr146);
	set_idt_entry(147,(unsigned int)isr147);
	set_idt_entry(148,(unsigned int)isr148);
	set_idt_entry(149,(unsigned int)isr149);
	set_idt_entry(150,(unsigned int)isr150);
	set_idt_entry(151,(unsigned int)isr151);
	set_idt_entry(152,(unsigned int)isr152);
	set_idt_entry(153,(unsigned int)isr153);
	set_idt_entry(154,(unsigned int)isr154);
	set_idt_entry(155,(unsigned int)isr155);
	set_idt_entry(156,(unsigned int)isr156);
	set_idt_entry(157,(unsigned int)isr157);
	set_idt_entry(158,(unsigned int)isr158);
	set_idt_entry(159,(unsigned int)isr159);
	set_idt_entry(160,(unsigned int)isr160);
	set_idt_entry(161,(unsigned int)isr161);
	set_idt_entry(162,(unsigned int)isr162);
	set_idt_entry(163,(unsigned int)isr163);
	set_idt_entry(164,(unsigned int)isr164);
	set_idt_entry(165,(unsigned int)isr165);
	set_idt_entry(166,(unsigned int)isr166);
	set_idt_entry(167,(unsigned int)isr167);
	set_idt_entry(168,(unsigned int)isr168);
	set_idt_entry(169,(unsigned int)isr169);
	set_idt_entry(170,(unsigned int)isr170);
	set_idt_entry(171,(unsigned int)isr171);
	set_idt_entry(172,(unsigned int)isr172);
	set_idt_entry(173,(unsigned int)isr173);
	set_idt_entry(174,(unsigned int)isr174);
	set_idt_entry(175,(unsigned int)isr175);
	set_idt_entry(176,(unsigned int)isr176);
	set_idt_entry(177,(unsigned int)isr177);
	set_idt_entry(178,(unsigned int)isr178);
	set_idt_entry(179,(unsigned int)isr179);
	set_idt_entry(180,(unsigned int)isr180);
	set_idt_entry(181,(unsigned int)isr181);
	set_idt_entry(182,(unsigned int)isr182);
	set_idt_entry(183,(unsigned int)isr183);
	set_idt_entry(184,(unsigned int)isr184);
	set_idt_entry(185,(unsigned int)isr185);
	set_idt_entry(186,(unsigned int)isr186);
	set_idt_entry(187,(unsigned int)isr187);
	set_idt_entry(188,(unsigned int)isr188);
	set_idt_entry(189,(unsigned int)isr189);
	set_idt_entry(190,(unsigned int)isr190);
	set_idt_entry(191,(unsigned int)isr191);
	set_idt_entry(192,(unsigned int)isr192);
	set_idt_entry(193,(unsigned int)isr193);
	set_idt_entry(194,(unsigned int)isr194);
	set_idt_entry(195,(unsigned int)isr195);
	set_idt_entry(196,(unsigned int)isr196);
	set_idt_entry(197,(unsigned int)isr197);
	set_idt_entry(198,(unsigned int)isr198);
	set_idt_entry(199,(unsigned int)isr199);
	set_idt_entry(200,(unsigned int)isr200);
	set_idt_entry(201,(unsigned int)isr201);
	set_idt_entry(202,(unsigned int)isr202);
	set_idt_entry(203,(unsigned int)isr203);
	set_idt_entry(204,(unsigned int)isr204);
	set_idt_entry(205,(unsigned int)isr205);
	set_idt_entry(206,(unsigned int)isr206);
	set_idt_entry(207,(unsigned int)isr207);
	set_idt_entry(208,(unsigned int)isr208);
	set_idt_entry(209,(unsigned int)isr209);
	set_idt_entry(210,(unsigned int)isr210);
	set_idt_entry(211,(unsigned int)isr211);
	set_idt_entry(212,(unsigned int)isr212);
	set_idt_entry(213,(unsigned int)isr213);
	set_idt_entry(214,(unsigned int)isr214);
	set_idt_entry(215,(unsigned int)isr215);
	set_idt_entry(216,(unsigned int)isr216);
	set_idt_entry(217,(unsigned int)isr217);
	set_idt_entry(218,(unsigned int)isr218);
	set_idt_entry(219,(unsigned int)isr219);
	set_idt_entry(220,(unsigned int)isr220);
	set_idt_entry(221,(unsigned int)isr221);
	set_idt_entry(222,(unsigned int)isr222);
	set_idt_entry(223,(unsigned int)isr223);
	set_idt_entry(224,(unsigned int)isr224);
	set_idt_entry(225,(unsigned int)isr225);
	set_idt_entry(226,(unsigned int)isr226);
	set_idt_entry(227,(unsigned int)isr227);
	set_idt_entry(228,(unsigned int)isr228);
	set_idt_entry(229,(unsigned int)isr229);
	set_idt_entry(230,(unsigned int)isr230);
	set_idt_entry(231,(unsigned int)isr231);
	set_idt_entry(232,(unsigned int)isr232);
	set_idt_entry(233,(unsigned int)isr233);
	set_idt_entry(234,(unsigned int)isr234);
	set_idt_entry(235,(unsigned int)isr235);
	set_idt_entry(236,(unsigned int)isr236);
	set_idt_entry(237,(unsigned int)isr237);
	set_idt_entry(238,(unsigned int)isr238);
	set_idt_entry(239,(unsigned int)isr239);
	set_idt_entry(240,(unsigned int)isr240);
	set_idt_entry(241,(unsigned int)isr241);
	set_idt_entry(242,(unsigned int)isr242);
	set_idt_entry(243,(unsigned int)isr243);
	set_idt_entry(244,(unsigned int)isr244);
	set_idt_entry(245,(unsigned int)isr245);
	set_idt_entry(246,(unsigned int)isr246);
	set_idt_entry(247,(unsigned int)isr247);
	set_idt_entry(248,(unsigned int)isr248);
	set_idt_entry(249,(unsigned int)isr249);
	set_idt_entry(250,(unsigned int)isr250);
	set_idt_entry(251,(unsigned int)isr251);
	set_idt_entry(252,(unsigned int)isr252);
	set_idt_entry(253,(unsigned int)isr253);
	set_idt_entry(254,(unsigned int)isr254);
	set_idt_entry(255,(unsigned int)isr255);

	load_idt((unsigned int) &idtr);

	init_irq();
	__asm__("sti");
}
